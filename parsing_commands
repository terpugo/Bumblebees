#!/bin/bash

if [ $# -ne 3 ]
then
  echo "Usage: <container name> <configuration number> <timestamp>"
  exit 1
fi

con_name=$1
config_num=$2
timestamp=$3

mitm_log="/home/aces/Bumblebees/${con_name}_logs/${con_name}_${timestamp}.log"

OUTDIR="/home/aces/Bumblebees/Attacker_Data"
mkdir -p "$OUTDIR"
epoch=$(date +%s)
outfile="${OUTDIR}/${con_name}_${timestamp}.txt"

echo "$con_name" >> "$outfile"
echo "$config_num" >> "$outfile"

attacker_ip=$(sudo cat ${mitm_log} | grep "Attacker connected" | cut -d' ' -f8 | head -1)
echo "$attacker_ip" >> "$outfile"

login_time=$(sudo cat ${mitm_log} | grep "Attacker authenticated" | cut -d' ' -f1-2 | head -1)
echo "$login_time" >> "$outfile"

exit_time=$(sudo cat ${outfile} | head -1 | cut -d' ' -f1-2)
echo "$exit_time" >> "$outfile"

list_commands=$(sudo cat ${mitm_log} | grep "line from read" | cut -d' ' -f9-)

if [ -z "$list_commands" ]; then
  # if we see "Noninteractive mode", dump those lines and then extract non-timestamp lines as commands
  if sudo grep -qF "Noninteractive mode" "$mitm_log" 2>/dev/null; then
    sudo grep "Noninteractive mode" "$mitm_log" | cut -d' ' -f10- 2>/dev/null >> "$outfile"

    # commands = lines that do NOT start with YYYY-MM-DD (likely the actual commands)
    list_commands=$(sudo grep -v -E '^[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}' "$mitm_log" 2>/dev/null || true)

    num_commands=$(echo "$list_commands" | sed '/^$/d' | wc -l)
    num_commands=$(( num_commands + 1 ))
    
  else
    num_commands=0
  fi
else
  num_commands=$(echo "$list_commands" | sed '/^$/d' | wc -l)
fi

echo "${num_commands}" >> "$outfile"

# append commands if present
if [ -n "$list_commands" ]; then
  echo "$list_commands" >> "$outfile"
fi

echo

s1=$(date -d "1970-01-01 $(echo $login_time | cut -d' ' -f2)" +%s)
s2=$(date -d "1970-01-01 $(echo $exit_time | cut -d' ' -f2)" +%s) 
diff=$((s2 - s1)) 
minutes=$((diff / 60)) 
seconds=$((diff % 60))

echo "$minutes minutes and $seconds seconds">> "$outfile"

sudo tail -n +2 "$outfile" > temp && sudo mv temp "$outfile"



